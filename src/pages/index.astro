---
import Main from "../layouts/Main.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import ContactForm from "../components/ContactForm.astro";
import Earth from "../components/Earth.astro";
import Rocket from "../components/Rocket.astro";

const posts = (await getCollection("notes"))
    .sort((a, b) => {
        const aDate = a.data.updatedAt || a.data.pubDate;
        const bDate = b.data.updatedAt || b.data.pubDate;
        return bDate.valueOf() - aDate.valueOf();
    })
    .slice(0, 5);
---

<Main title={SITE_TITLE} description={SITE_DESCRIPTION}>
    <section>
        <div class="note note--me">
            <img src="/avatar.png" alt="portrait of me in spacesuit" />
            <h3>Hello! I'm Piotr Kielak</h3>
            <p>
                I'm a front-end developer with a few years of experience in web
                development and enjoy sharing my thoughts through this digital
                garden project.
            </p>
            <p>
                If you're interested in the structure or exploring different
                parts of my digital garden, check the node diagram below or jump
                straight in{" "}
                <a href="/notes/index">here</a>!
            </p>
        </div>
    </section>

    <section>
        <div class="note">
            <p>
                My main focus as a developer is building useful applications and
                websites tailored for daily users tasks. Some of my earlier
                projects have succeeded in this, which motivates me to keep
                creating great solutions.
            </p>
            <p>
                Skilled in React and TypeScript, I'm learning Next.js, Astro,
                PostgreSQL, and AI agents to expand my full-stack development
                skills.
            </p>
        </div>
    </section>

    <section>
        <div class="note">
            <h3>Recent notes</h3>
            <ul>
                {
                    posts.map((post) => (
                        <li>
                            <a href={`/notes/${post.id}/`} class="post-link">
                                <h4 class="title">{post.data.title}</h4>
                                <p class="date">
                                    <FormattedDate
                                        date={
                                            post.data.updatedAt ||
                                            post.data.pubDate
                                        }
                                    />
                                </p>
                                <p class="description">
                                    {post.data.description}
                                </p>
                            </a>
                        </li>
                    ))
                }
            </ul>
        </div>
    </section>

    <section>
        <div class="note">
            <h3>Contact Me</h3>
            <ContactForm />
        </div>
    </section>

    <Earth />
    <Rocket />
</Main>

<style>
    section {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: calc(100% - 2rem);
        max-width: 1024px;
        height: 100svh;
        padding-top: 2rem;
        margin: 0 auto;
        scroll-snap-align: start;
        z-index: 200;
    }

    section:last-of-type {
        height: calc(50svh + var(--contact-form-height) / 2);
        align-items: flex-end;
    }

    @media (min-width: 768px) {
        section {
            height: 100vh;
        }

        section:nth-child(odd) {
            justify-content: flex-end;
        }

        section:nth-child(even) {
            justify-content: flex-start;
        }

        section:nth-child(1) {
            justify-content: center;
        }

        section:last-of-type {
            height: calc(50svh + var(--contact-form-height-desktop) / 2);
            align-items: flex-end;
        }
    }

    .note {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        width: 100%;
        background: var(--nord4-snow-storm);
        box-shadow: var(--shadow-4);
        font-weight: 400;
        color: var(--nord1-polar-night);
        z-index: 999;
    }

    .note h3,
    .note p,
    .note img {
        margin: 0;
    }

    .note--me {
        animation-timeline: scroll(root);
        animation-duration: 1.2s;
        animation-range: auto;
        animation-name: earthMove;
        animation-fill-mode: both;
        animation-timing-function: ease-in-out;
    }

    @keyframes earthMove {
        0% {
            transform: translateX(0);
        }
        20% {
            transform: translateX(-100vw);
        }
    }

    .note--me img {
        width: 75%;
    }

    @media (min-width: 768px) {
        .note {
            width: 50%;
            padding: 2rem;
        }

        .note--me img {
            width: 100%;
        }
    }

    h3 {
        font-size: 1.563em;
        text-align: center;
    }

    @media (min-width: 720px) {
        h3 {
            font-size: 1.953em;
        }
    }

    ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .post-link {
        display: block;
        text-decoration: none;
        color: var(--nord1-polar-night);
        font-weight: 400;
        background: var(--nord4-snow-storm);
        border-radius: 0;
        transition: color 0.2s ease;
    }

    .post-link:hover h4,
    .post-link:hover .date {
        color: var(--nord10-frost);
    }

    .title {
        margin: 0;
        line-height: 1;
    }

    .date,
    .description {
        margin: 0;
        color: var(--nord3-snow-storm);
    }

    @media (max-width: 720px) {
        ul {
            gap: 0.5em;
        }

        ul li:first-child .title {
            font-size: 1.563em;
        }
    }

    .note:not(.note--me) {
        transition: transform 1.2s ease-in-out;
    }

    section:nth-child(odd) .note:not(.note--me) {
        transform: translateX(50vw) scale(0.1);
    }

    section:nth-child(even) .note:not(.note--me) {
        transform: translateX(-50vw) scale(0.1);
    }

    section .note:not(.note--me).visible {
        transform: translateX(0) scale(1);
    }
</style>

<script>
    if (typeof window !== "undefined") {
        window.addEventListener("DOMContentLoaded", () => {
            const sections = document.querySelectorAll(
                "section:not(:first-child)",
            );

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        const note = entry.target.querySelector(".note");
                        if (!note || note.classList.contains("note--me"))
                            return;

                        if (entry.isIntersecting) {
                            note.classList.add("visible");
                        } else {
                            note.classList.remove("visible");
                        }
                    });
                },
                {
                    root: null,
                    rootMargin: "0px",
                    threshold: 0.05,
                },
            );

            sections.forEach((section) => observer.observe(section));
        });
    }
</script>
