---
import Main from "../layouts/Main.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import ContactForm from "../components/ContactForm.astro";
import Earth from "../components/Earth.astro";
import Rocket from "../components/Rocket.astro";

const posts = (await getCollection("notes"))
    .sort((a: any, b: any) => {
        const aDate = a.data.updatedAt || a.data.pubDate;
        const bDate = b.data.updatedAt || b.data.pubDate;
        return bDate.valueOf() - aDate.valueOf();
    })
    .slice(0, 5);
---

<Main title={SITE_TITLE} description={SITE_DESCRIPTION}>
    <section>
        <div class="note note--me">
            <img src="/avatar.png" alt="portrait of me in spacesuit" />
            <h3>Hello! I'm Piotr Kielak</h3>
            <p>
                I'm a front-end developer with a few years of experience in web
                development and enjoy sharing my thoughts through this digital
                garden project.
            </p>
            <p>
                If you're interested in seeing how everything is organized or
                exploring the various sections within my digital garden, take a
                look at the node diagram at the bottom of the page or dive right
                into it <a href="/notes/index">here</a>!
            </p>
        </div>
    </section>

    <section>
        <div class="note">
            <p>
                My main focus as a developer is to create helpful applications
                and websites designed for users' daily tasks and activities.
                Some of my earlier projects have achieved this goal, which keeps
                me motivated to continue making useful solutions.
            </p>
            <p>
                Skilled in React and TypeScript, I am also learning Next.js,
                Astro, PostgreSQL, and AI agents to broaden my expertise in
                full-stack web development.
            </p>
        </div>
    </section>

    <section>
        <div class="note">
            <h3>Recent notes</h3>
            <ul>
                {
                    posts.map((post: any, index: number) => (
                        <li>
                            <a href={`/notes/${post.id}/`}>
                                <h4 class="title">{post.data.title}</h4>
                                <p class="date">
                                    <FormattedDate
                                        date={
                                            post.data.updatedAt ||
                                            post.data.pubDate
                                        }
                                    />
                                </p>
                                <p class="description">
                                    {post.data.description}
                                </p>
                            </a>
                        </li>
                    ))
                }
            </ul>
        </div>
    </section>

    <section>
        <div class="note">
            <h3>Contact Me</h3>
            <ContactForm />
        </div>
    </section>

    <Earth />
    <Rocket />
</Main>

<style>
    section {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: calc(100% - 2rem);
        max-width: 1024px;
        height: 100svh;
        padding-top: 2rem;
        margin: 0 auto;
        scroll-snap-align: start;
        z-index: 200;
    }

    section:last-of-type {
        height: calc(50svh + var(--contact-form-height) / 2);
        align-items: end;
    }

    @media (min-width: 768px) {
        section {
            height: 100vh;
        }

        section:nth-child(odd) {
            justify-content: flex-end;
        }

        section:nth-child(even) {
            justify-content: flex-start;
        }

        section:nth-child(1) {
            justify-content: center;
        }

        section:last-of-type {
            height: calc(50svh + var(--contact-form-height-desktop) / 2);
            align-items: end;
        }
    }

    .note {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        position: relative;
        padding: 1rem;
        width: 100%;
        background: var(--nord4-snow-storm);
        border-radius: 0;
        box-shadow: var(--shadow-4);
        font-weight: 400;
        color: var(--nord1-polar-night);
        z-index: 999;
    }

    .note h3,
    .note p,
    .note img {
        margin: 0;
    }

    .note--me img {
        width: 75%;
    }

    @media (min-width: 768px) {
        .note {
            width: 50%;
            padding: 2rem;
        }

        .note--me {
            animation-timeline: scroll(root);
            animation-range: auto;
            animation-name: earthMove;
            animation-fill-mode: both;
            animation-timing-function: ease-in-out;
        }

        .note--me img {
            width: 100%;
        }

        @keyframes earthMove {
            0% {
                transform: translateX(0px);
            }
            20% {
                transform: translateX(-100vw);
            }
        }
    }

    h3 {
        font-size: 1.563em;
        text-align: center;
    }

    ul {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    ul li a {
        display: block;
        text-decoration: none;
        border-radius: 0;
        background: var(--nord4-snow-storm);
        color: var(--nord1-polar-night);
        font-weight: 400;
        transition: color 0.2s ease;
    }

    ul li a:hover h4,
    ul li a:hover .date {
        color: var(--nord10-frost);
    }

    .title {
        margin: 0;
        line-height: 1;
    }

    .date,
    .description {
        margin: 0;
        color: var(--nord3-snow-storm);
    }

    ul li a:hover h4,
    ul li a:hover .date {
        color: var(--nord10-frost);
    }

    @media (max-width: 720px) {
        ul {
            gap: 0.5em;
        }

        ul li:first-child {
            margin-bottom: 0;
        }

        ul li:first-child .title {
            font-size: 1.563em;
        }
    }

    @media (min-width: 720px) {
        h3 {
            font-size: 1.953em;
        }
    }

    .note:not(.note--me) {
        transition: transform 1.2s ease-in-out;
    }

    section:nth-child(odd) .note:not(.note--me) {
        transform: translateX(50vw) scale(0.1);
    }

    section:nth-child(even) .note:not(.note--me) {
        transform: translateX(-50vw) scale(0.1);
    }

    section .note:not(.note--me).visible {
        transform: translateX(0) scale(1);
    }
</style>

<script>
    if (typeof window !== "undefined") {
        window.addEventListener("DOMContentLoaded", () => {
            const sections = document.querySelectorAll(
                "section:not(:first-child)",
            );

            const options = {
                root: null,
                rootMargin: "0px",
                threshold: 0.1,
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    const note = entry.target.querySelector(".note");
                    if (!note || note.classList.contains("note--me")) return;

                    if (entry.isIntersecting) {
                        note.classList.add("visible");
                    } else {
                        note.classList.remove("visible");
                    }
                });
            }, options);

            sections.forEach((section) => {
                observer.observe(section);
            });
        });
    }
</script>
